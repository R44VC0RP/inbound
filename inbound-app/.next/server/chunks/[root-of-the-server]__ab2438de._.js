module.exports={929549:function(e){var{g:s,__dirname:r,m:t,e:a}=e;t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},983943:function(e){var{g:s,__dirname:r,m:t,e:a}=e;t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},86103:function(e){var{g:s,__dirname:r,m:t,e:a}=e;t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},945935:function(e){var{g:s,__dirname:r,m:t,e:a}=e;t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},348629:function(e){var{g:s,__dirname:r,m:t,e:a}=e;t.exports=e.x("@opentelemetry/api",()=>require("@opentelemetry/api"))},76569:function(e){var{g:s,__dirname:r,m:t,e:a}=e;t.exports=e.x("node:events",()=>require("node:events"))},804713:function(e){var{g:s,__dirname:r,m:t,e:a}=e;t.exports=e.x("util",()=>require("util"))},87485:function(e){var{g:s,__dirname:r,m:t,e:a}=e;t.exports=e.x("child_process",()=>require("child_process"))},420467:function(e){var{g:s,__dirname:r,m:t,e:a}=e;t.exports=e.x("events",()=>require("events"))},936121:function(e){var{g:s,__dirname:r,m:t,e:a}=e;t.exports=e.x("node:util",()=>require("node:util"))},681635:function(e){var{g:s,__dirname:r,m:t,e:a}=e;t.exports=e.x("node:http",()=>require("node:http"))},866098:function(e){var{g:s,__dirname:r,m:t,e:a}=e;t.exports=e.x("node:https",()=>require("node:https"))},580767:function(e){var{g:s,__dirname:r,m:t,e:a}=e;t.exports=e.x("node:buffer",()=>require("node:buffer"))},329295:function(e){var{g:s,__dirname:r,m:t,e:a}=e;t.exports=e.x("crypto",()=>require("crypto"))},62445:function(e){var{g:s,__dirname:r,m:t,e:a}=e;t.exports=e.x("http",()=>require("http"))},348388:function(e){var{g:s,__dirname:r,m:t,e:a}=e;t.exports=e.x("https",()=>require("https"))},591032:function(e){var{g:s,__dirname:r,m:t,e:a}=e;t.exports=e.x("node:crypto",()=>require("node:crypto"))},909834:e=>{"use strict";var{g:s,__dirname:r}=e;e.s({DELIVERY_STATUS:()=>a.DELIVERY_STATUS,DELIVERY_TYPES:()=>a.DELIVERY_TYPES,DOMAIN_STATUS:()=>a.DOMAIN_STATUS,EMAIL_STATUS:()=>a.EMAIL_STATUS,ENDPOINT_TYPES:()=>a.ENDPOINT_TYPES,PROVIDER_CONFIDENCE:()=>a.PROVIDER_CONFIDENCE,SENT_EMAIL_STATUS:()=>a.SENT_EMAIL_STATUS,SES_VERIFICATION_STATUS:()=>a.SES_VERIFICATION_STATUS,VIP_PAYMENT_STATUS:()=>a.VIP_PAYMENT_STATUS,WEBHOOK_FORMATS:()=>a.WEBHOOK_FORMATS,WEBHOOK_STATUS:()=>a.WEBHOOK_STATUS,account:()=>t.account,apikey:()=>t.apikey,blockedEmails:()=>a.blockedEmails,domainDnsRecords:()=>a.domainDnsRecords,emailAddresses:()=>a.emailAddresses,emailDomains:()=>a.emailDomains,emailGroups:()=>a.emailGroups,endpointDeliveries:()=>a.endpointDeliveries,endpoints:()=>a.endpoints,parsedEmails:()=>a.parsedEmails,receivedEmails:()=>a.receivedEmails,sentEmails:()=>a.sentEmails,sesEvents:()=>a.sesEvents,session:()=>t.session,structuredEmails:()=>a.structuredEmails,subscriptions:()=>a.subscriptions,user:()=>t.user,userAccounts:()=>a.userAccounts,userOnboarding:()=>a.userOnboarding,verification:()=>t.verification,vipAllowedSenders:()=>a.vipAllowedSenders,vipConfigs:()=>a.vipConfigs,vipEmailAttempts:()=>a.vipEmailAttempts,vipPaymentSessions:()=>a.vipPaymentSessions,webhookDeliveries:()=>a.webhookDeliveries,webhooks:()=>a.webhooks});var t=e.i(594120),a=e.i(55379)},436754:e=>{"use strict";var{g:s,__dirname:r}=e;e.s({DELIVERY_STATUS:()=>t.DELIVERY_STATUS,DELIVERY_TYPES:()=>t.DELIVERY_TYPES,DOMAIN_STATUS:()=>t.DOMAIN_STATUS,EMAIL_STATUS:()=>t.EMAIL_STATUS,ENDPOINT_TYPES:()=>t.ENDPOINT_TYPES,PROVIDER_CONFIDENCE:()=>t.PROVIDER_CONFIDENCE,SENT_EMAIL_STATUS:()=>t.SENT_EMAIL_STATUS,SES_VERIFICATION_STATUS:()=>t.SES_VERIFICATION_STATUS,VIP_PAYMENT_STATUS:()=>t.VIP_PAYMENT_STATUS,WEBHOOK_FORMATS:()=>t.WEBHOOK_FORMATS,WEBHOOK_STATUS:()=>t.WEBHOOK_STATUS,account:()=>t.account,apikey:()=>t.apikey,blockedEmails:()=>t.blockedEmails,domainDnsRecords:()=>t.domainDnsRecords,emailAddresses:()=>t.emailAddresses,emailDomains:()=>t.emailDomains,emailGroups:()=>t.emailGroups,endpointDeliveries:()=>t.endpointDeliveries,endpoints:()=>t.endpoints,parsedEmails:()=>t.parsedEmails,receivedEmails:()=>t.receivedEmails,sentEmails:()=>t.sentEmails,sesEvents:()=>t.sesEvents,session:()=>t.session,structuredEmails:()=>t.structuredEmails,subscriptions:()=>t.subscriptions,user:()=>t.user,userAccounts:()=>t.userAccounts,userOnboarding:()=>t.userOnboarding,verification:()=>t.verification,vipAllowedSenders:()=>t.vipAllowedSenders,vipConfigs:()=>t.vipConfigs,vipEmailAttempts:()=>t.vipEmailAttempts,vipPaymentSessions:()=>t.vipPaymentSessions,webhookDeliveries:()=>t.webhookDeliveries,webhooks:()=>t.webhooks}),e.i(468686);var t=e.i(909834)},153364:function(e){var{g:s,__dirname:r,m:t,e:a}=e;"use strict";t.exports=e.r(68043).vendored["react-rsc"].ReactServerDOMTurbopackServerEdge},933966:function(e){var{g:s,__dirname:r,m:t,e:a}=e},55770:e=>{"use strict";var{g:s,__dirname:r}=e;e.s({GET:()=>m});var t=e.i(125427),a=e.i(494642),n=e.i(557440);e.i(468686);var i=e.i(55379),o=e.i(176825);function d(e){return e?e.replace(/[<>]/g,"").trim():""}function l(e){if(!e)return"";let s=e.trim(),r=/^(re|r|fwd|fw|aw|wg|vs|sv):\s*/i;for(;r.test(s);)s=s.replace(r,"").trim();return s.toLowerCase()}function u(e){if(!e)return[];try{if(e.startsWith("[")){let s=JSON.parse(e);if(Array.isArray(s))return s.map(d).filter(e=>e)}return e.replace(/\s+/g," ").split(" ").map(d).filter(e=>e)}catch(e){return console.error("Failed to parse references:",e),[]}}async function c(e,s){console.log("🔗 Getting thread message IDs for email:",s);let r=await n.db.select({id:i.structuredEmails.id,messageId:i.structuredEmails.messageId,inReplyTo:i.structuredEmails.inReplyTo,references:i.structuredEmails.references,subject:i.structuredEmails.subject,userId:i.structuredEmails.userId}).from(i.structuredEmails).where((0,o.and)((0,o.eq)(i.structuredEmails.id,s),(0,o.eq)(i.structuredEmails.userId,e))).limit(1);if(0===r.length)return{messageIds:[],normalizedSubject:""};let t=r[0],a=new Set;t.messageId&&a.add(d(t.messageId)),t.inReplyTo&&a.add(d(t.inReplyTo)),t.references&&u(t.references).forEach(e=>a.add(e));let c=new Set,m=Array.from(a);for(;m.length>0;){let s=m.pop();if(c.has(s))continue;c.add(s);let r=await n.db.select({messageId:i.structuredEmails.messageId,inReplyTo:i.structuredEmails.inReplyTo,references:i.structuredEmails.references}).from(i.structuredEmails).where((0,o.and)((0,o.eq)(i.structuredEmails.userId,e),(0,o.or)((0,o.eq)(i.structuredEmails.messageId,s),(0,o.eq)(i.structuredEmails.inReplyTo,`<${s}>`),(0,o.like)(i.structuredEmails.references,`%${s}%`)))),t=await n.db.select({messageId:i.sentEmails.messageId,headers:i.sentEmails.headers}).from(i.sentEmails).where((0,o.and)((0,o.eq)(i.sentEmails.userId,e),(0,o.or)((0,o.eq)(i.sentEmails.messageId,s),(0,o.like)(i.sentEmails.headers,`%${s}%`))));for(let e of r){if(e.messageId){let s=d(e.messageId);c.has(s)||(a.add(s),m.push(s))}if(e.inReplyTo){let s=d(e.inReplyTo);c.has(s)||(a.add(s),m.push(s))}e.references&&u(e.references).forEach(e=>{c.has(e)||(a.add(e),m.push(e))})}for(let e of t){if(e.messageId){let s=d(e.messageId);c.has(s)||(a.add(s),m.push(s))}if(e.headers)try{let s=JSON.parse(e.headers);if(s["In-Reply-To"]){let e=d(s["In-Reply-To"]);c.has(e)||(a.add(e),m.push(e))}s.References&&u(s.References).forEach(e=>{c.has(e)||(a.add(e),m.push(e))})}catch(e){console.error("Failed to parse sent email headers:",e)}}}let p=l(t.subject||"");return console.log(`🔗 Found ${a.size} message IDs in thread:`,Array.from(a)),{messageIds:Array.from(a).filter(e=>e),normalizedSubject:p}}async function m(e,{params:s}){console.log("🧵 GET /api/v2/mail/[id]/thread - Starting request");try{console.log("🔐 Validating request authentication");let{userId:r,error:d}=await (0,a.validateRequest)(e);if(!r)return console.log("❌ Authentication failed:",d),t.NextResponse.json({error:d},{status:401});console.log("✅ Authentication successful for userId:",r);let{id:m}=await s;if(console.log("📨 Requested thread for email ID:",m),!m||"string"!=typeof m)return console.log("⚠️ Invalid email ID provided:",m),t.NextResponse.json({error:"Valid email ID is required"},{status:400});let{messageIds:p,normalizedSubject:E}=await c(r,m);0===p.length&&(console.log("📭 No threading information found, treating as single email"),p.push(m)),console.log("📥 Fetching inbound emails in thread");let f=await n.db.select().from(i.structuredEmails).where((0,o.and)((0,o.eq)(i.structuredEmails.userId,r),(0,o.or)((0,o.inArray)(i.structuredEmails.messageId,p),(0,o.inArray)(i.structuredEmails.inReplyTo,p.map(e=>`<${e}>`)),(0,o.eq)(i.structuredEmails.id,m))));console.log("📤 Fetching outbound emails in thread");let g=await n.db.select().from(i.sentEmails).where((0,o.and)((0,o.eq)(i.sentEmails.userId,r),(0,o.or)((0,o.inArray)(i.sentEmails.messageId,p))));if(f.length+g.length<=1&&E){console.log("🔄 Attempting subject-based threading fallback");let e=await n.db.select().from(i.structuredEmails).where((0,o.and)((0,o.eq)(i.structuredEmails.userId,r),(0,o.like)(i.structuredEmails.subject,`%${E}%`))),s=await n.db.select().from(i.sentEmails).where((0,o.and)((0,o.eq)(i.sentEmails.userId,r),(0,o.like)(i.sentEmails.subject,`%${E}%`))),t=e.filter(e=>l(e.subject||"")===E),a=s.filter(e=>l(e.subject||"")===E);t.length>f.length&&(console.log(`📧 Subject threading found ${t.length} additional inbound emails`),f=t),a.length>g.length&&(console.log(`📤 Subject threading found ${a.length} additional outbound emails`),g=a)}console.log(`📊 Found ${f.length} inbound and ${g.length} outbound emails`);let h=[];for(let e of f){let s=null,r=null,t=[];try{s=e.fromData?JSON.parse(e.fromData):null,r=e.toData?JSON.parse(e.toData):null,t=e.attachments?JSON.parse(e.attachments):[]}catch(e){console.error("Failed to parse email data:",e)}let a=[];try{a=e.references?u(e.references):[]}catch(e){console.error("Failed to parse references:",e)}h.push({id:e.id,messageId:e.messageId,type:"inbound",subject:e.subject,from:s?.text||"Unknown Sender",fromName:s?.addresses?.[0]?.name||null,to:r?.text||r?.addresses?.[0]?.address||"Unknown Recipient",receivedAt:e.date,sentAt:null,content:{textBody:e.textBody,htmlBody:e.htmlBody,attachments:t},addresses:{from:s,to:r},metadata:{inReplyTo:e.inReplyTo,references:a,parseSuccess:e.parseSuccess,parseError:e.parseError},isRead:e.isRead||!1,readAt:e.readAt})}for(let e of g){let s=[],r={},t=[];try{s=e.to?JSON.parse(e.to):[],r=e.headers?JSON.parse(e.headers):{},t=e.attachments?JSON.parse(e.attachments):[]}catch(e){console.error("Failed to parse sent email data:",e)}let a=r.References?u(r.References):[];h.push({id:e.id,messageId:e.messageId,type:"outbound",subject:e.subject,from:e.from,fromName:null,to:s.join(", "),receivedAt:null,sentAt:e.sentAt,content:{textBody:e.textBody,htmlBody:e.htmlBody,attachments:t},addresses:{from:{text:e.from,addresses:[{name:null,address:e.fromAddress}]},to:{text:s.join(", "),addresses:s.map(e=>({name:null,address:e}))}},metadata:{inReplyTo:r["In-Reply-To"]||null,references:a,parseSuccess:!0,parseError:null},isRead:!0,readAt:e.sentAt})}h.sort((e,s)=>{let r=e.receivedAt||e.sentAt||new Date(0),t=s.receivedAt||s.sentAt||new Date(0);return new Date(r).getTime()-new Date(t).getTime()});let S=h.length>0?h[0].messageId||h[0].id:E||m;return console.log(`✅ Successfully retrieved thread with ${h.length} messages`),t.NextResponse.json({messages:h,totalCount:h.length,threadId:S})}catch(e){return console.error("💥 Unexpected error in GET /api/v2/mail/[id]/thread:",e),t.NextResponse.json({error:"Internal server error"},{status:500})}}},392159:e=>{"use strict";var{g:s,__dirname:r}=e;{e.s({patchFetch:()=>o,routeModule:()=>s,serverHooks:()=>l,workAsyncStorage:()=>r,workUnitAsyncStorage:()=>d});var t=e.i(854885),a=e.i(814689),n=e.i(25402),i=e.i(55770);let s=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/v2/mail/[id]/thread/route",pathname:"/api/v2/mail/[id]/thread",filename:"route",bundlePath:""},resolvedPagePath:"[project]/app/api/v2/mail/[id]/thread/route.ts",nextConfigOutput:"",userland:i}),{workAsyncStorage:r,workUnitAsyncStorage:d,serverHooks:l}=s;function o(){return(0,n.patchFetch)({workAsyncStorage:r,workUnitAsyncStorage:d})}}},993477:e=>{var{g:s,__dirname:r}=e;e.v(s=>Promise.all(["server/chunks/[root-of-the-server]__9e0d9ac2._.js","server/chunks/node_modules_10ae7a2d._.js"].map(s=>e.l(s))).then(()=>s(611487)))}};

//# sourceMappingURL=%5Broot-of-the-server%5D__ab2438de._.js.map