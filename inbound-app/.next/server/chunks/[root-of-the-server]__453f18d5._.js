module.exports={929549:function(e){var{g:s,__dirname:t,m:r,e:i}=e;r.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},983943:function(e){var{g:s,__dirname:t,m:r,e:i}=e;r.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},86103:function(e){var{g:s,__dirname:t,m:r,e:i}=e;r.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},945935:function(e){var{g:s,__dirname:t,m:r,e:i}=e;r.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},348629:function(e){var{g:s,__dirname:t,m:r,e:i}=e;r.exports=e.x("@opentelemetry/api",()=>require("@opentelemetry/api"))},76569:function(e){var{g:s,__dirname:t,m:r,e:i}=e;r.exports=e.x("node:events",()=>require("node:events"))},804713:function(e){var{g:s,__dirname:t,m:r,e:i}=e;r.exports=e.x("util",()=>require("util"))},87485:function(e){var{g:s,__dirname:t,m:r,e:i}=e;r.exports=e.x("child_process",()=>require("child_process"))},420467:function(e){var{g:s,__dirname:t,m:r,e:i}=e;r.exports=e.x("events",()=>require("events"))},936121:function(e){var{g:s,__dirname:t,m:r,e:i}=e;r.exports=e.x("node:util",()=>require("node:util"))},681635:function(e){var{g:s,__dirname:t,m:r,e:i}=e;r.exports=e.x("node:http",()=>require("node:http"))},866098:function(e){var{g:s,__dirname:t,m:r,e:i}=e;r.exports=e.x("node:https",()=>require("node:https"))},580767:function(e){var{g:s,__dirname:t,m:r,e:i}=e;r.exports=e.x("node:buffer",()=>require("node:buffer"))},329295:function(e){var{g:s,__dirname:t,m:r,e:i}=e;r.exports=e.x("crypto",()=>require("crypto"))},62445:function(e){var{g:s,__dirname:t,m:r,e:i}=e;r.exports=e.x("http",()=>require("http"))},348388:function(e){var{g:s,__dirname:t,m:r,e:i}=e;r.exports=e.x("https",()=>require("https"))},591032:function(e){var{g:s,__dirname:t,m:r,e:i}=e;r.exports=e.x("node:crypto",()=>require("node:crypto"))},909834:e=>{"use strict";var{g:s,__dirname:t}=e;e.s({DELIVERY_STATUS:()=>i.DELIVERY_STATUS,DELIVERY_TYPES:()=>i.DELIVERY_TYPES,DOMAIN_STATUS:()=>i.DOMAIN_STATUS,EMAIL_STATUS:()=>i.EMAIL_STATUS,ENDPOINT_TYPES:()=>i.ENDPOINT_TYPES,PROVIDER_CONFIDENCE:()=>i.PROVIDER_CONFIDENCE,SENT_EMAIL_STATUS:()=>i.SENT_EMAIL_STATUS,SES_VERIFICATION_STATUS:()=>i.SES_VERIFICATION_STATUS,VIP_PAYMENT_STATUS:()=>i.VIP_PAYMENT_STATUS,WEBHOOK_FORMATS:()=>i.WEBHOOK_FORMATS,WEBHOOK_STATUS:()=>i.WEBHOOK_STATUS,account:()=>r.account,apikey:()=>r.apikey,blockedEmails:()=>i.blockedEmails,domainDnsRecords:()=>i.domainDnsRecords,emailAddresses:()=>i.emailAddresses,emailDomains:()=>i.emailDomains,emailGroups:()=>i.emailGroups,endpointDeliveries:()=>i.endpointDeliveries,endpoints:()=>i.endpoints,parsedEmails:()=>i.parsedEmails,receivedEmails:()=>i.receivedEmails,sentEmails:()=>i.sentEmails,sesEvents:()=>i.sesEvents,session:()=>r.session,structuredEmails:()=>i.structuredEmails,subscriptions:()=>i.subscriptions,user:()=>r.user,userAccounts:()=>i.userAccounts,userOnboarding:()=>i.userOnboarding,verification:()=>r.verification,vipAllowedSenders:()=>i.vipAllowedSenders,vipConfigs:()=>i.vipConfigs,vipEmailAttempts:()=>i.vipEmailAttempts,vipPaymentSessions:()=>i.vipPaymentSessions,webhookDeliveries:()=>i.webhookDeliveries,webhooks:()=>i.webhooks});var r=e.i(594120),i=e.i(55379)},436754:e=>{"use strict";var{g:s,__dirname:t}=e;e.s({DELIVERY_STATUS:()=>r.DELIVERY_STATUS,DELIVERY_TYPES:()=>r.DELIVERY_TYPES,DOMAIN_STATUS:()=>r.DOMAIN_STATUS,EMAIL_STATUS:()=>r.EMAIL_STATUS,ENDPOINT_TYPES:()=>r.ENDPOINT_TYPES,PROVIDER_CONFIDENCE:()=>r.PROVIDER_CONFIDENCE,SENT_EMAIL_STATUS:()=>r.SENT_EMAIL_STATUS,SES_VERIFICATION_STATUS:()=>r.SES_VERIFICATION_STATUS,VIP_PAYMENT_STATUS:()=>r.VIP_PAYMENT_STATUS,WEBHOOK_FORMATS:()=>r.WEBHOOK_FORMATS,WEBHOOK_STATUS:()=>r.WEBHOOK_STATUS,account:()=>r.account,apikey:()=>r.apikey,blockedEmails:()=>r.blockedEmails,domainDnsRecords:()=>r.domainDnsRecords,emailAddresses:()=>r.emailAddresses,emailDomains:()=>r.emailDomains,emailGroups:()=>r.emailGroups,endpointDeliveries:()=>r.endpointDeliveries,endpoints:()=>r.endpoints,parsedEmails:()=>r.parsedEmails,receivedEmails:()=>r.receivedEmails,sentEmails:()=>r.sentEmails,sesEvents:()=>r.sesEvents,session:()=>r.session,structuredEmails:()=>r.structuredEmails,subscriptions:()=>r.subscriptions,user:()=>r.user,userAccounts:()=>r.userAccounts,userOnboarding:()=>r.userOnboarding,verification:()=>r.verification,vipAllowedSenders:()=>r.vipAllowedSenders,vipConfigs:()=>r.vipConfigs,vipEmailAttempts:()=>r.vipEmailAttempts,vipPaymentSessions:()=>r.vipPaymentSessions,webhookDeliveries:()=>r.webhookDeliveries,webhooks:()=>r.webhooks}),e.i(468686);var r=e.i(909834)},153364:function(e){var{g:s,__dirname:t,m:r,e:i}=e;"use strict";r.exports=e.r(68043).vendored["react-rsc"].ReactServerDOMTurbopackServerEdge},459351:e=>{"use strict";var{g:s,__dirname:t}=e;e.s({AppEnv:()=>R,Autumn:()=>k,AutumnError:()=>a,FreeTrialDuration:()=>C,Infinite:()=>j,ProductItemInterval:()=>q,ProductStatus:()=>U,UsageModel:()=>M,fetchPricingTable:()=>L,toContainerResult:()=>P});var r=Object.defineProperty,i=(e,s,t)=>s in e?r(e,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[s]=t,n=(e,s,t)=>i(e,"symbol"!=typeof s?s+"":s,t),a=class extends Error{constructor(e){super(e.message),n(this,"message"),n(this,"code"),this.message=e.message,this.code=e.code}toString(){return`${this.message} (code: ${this.code})`}toJSON(){return{message:this.message,code:this.code}}},o=(e,s,t)=>(s||(s=new k),e({instance:s,...t})),l=e=>({get:(s,t)=>o(d,e,{id:s,params:t}),create:s=>o(u,e,{params:s}),update:(s,t)=>o(m,e,{id:s,params:t}),delete:s=>o(p,e,{id:s}),billingPortal:(s,t)=>o(h,e,{id:s,params:t})}),c=e=>e?`expand=${e.join(",")}`:"",d=async({instance:e,id:s,params:t})=>s?e.get(`/customers/${s}?${c(t?.expand)}`):{data:null,error:new a({message:"Customer ID is required",code:"CUSTOMER_ID_REQUIRED"})},u=async({instance:e,params:s})=>e.post(`/customers?${c(s?.expand)}`,s),m=async({instance:e,id:s,params:t})=>e.post(`/customers/${s}`,t),p=async({instance:e,id:s})=>e.delete(`/customers/${s}`),h=async({instance:e,id:s,params:t})=>e.post(`/customers/${s}/billing_portal`,t),v=e=>({get:(s,t,r)=>o(E,e,{customer_id:s,entity_id:t,params:r}),create:(s,t)=>o(g,e,{customer_id:s,params:t}),delete:(s,t)=>o(_,e,{customer_id:s,entity_id:t})}),S=e=>e?`expand=${e.join(",")}`:"",E=async({instance:e,customer_id:s,entity_id:t,params:r})=>e.get(`/customers/${s}/entities/${t}?${S(r?.expand)}`),g=async({instance:e,customer_id:s,params:t})=>e.post(`/customers/${s}/entities`,t),_=async({instance:e,customer_id:s,entity_id:t})=>e.delete(`/customers/${s}/entities/${t}`),f=async({instance:e,params:s})=>e.post("/attach",s),A=async({instance:e,params:s})=>e.post("/cancel",s),T=async({instance:e,params:s})=>e.post("/entitled",s),y=async({instance:e,params:s})=>e.post("/events",s),x=async({instance:e,params:s})=>e.post("/track",s),b=async({instance:e,params:s})=>e.post("/usage",s),I=async({instance:e,params:s})=>e.post("/check",s),w=e=>({get:s=>o(O,e,{id:s}),create:s=>o(N,e,{params:s}),list:s=>o(D,e,{params:s})}),D=async({instance:e,params:s})=>{let t="/products";if(s){let e=new URLSearchParams;for(let[t,r]of Object.entries(s))void 0!==r&&e.append(t,String(r));let r=e.toString();r&&(t+=`?${r}`)}return e.get(t)},O=async({instance:e,id:s})=>e.get(`/products/${s}`),N=async({instance:e,params:s})=>e.post("/products",s),P=async e=>{if(e.status<200||e.status>=300){let s;try{s=await e.json()}catch(s){return{data:null,error:new a({message:"Failed to parse JSON response from Autumn",code:"internal_error"}),statusCode:e.status}}return{data:null,error:new a({message:s.message,code:s.code}),statusCode:e.status}}try{return{data:await e.json(),error:null,statusCode:e?.status}}catch(s){return{data:null,error:new a({message:"Failed to parse Autumn API response",code:"internal_error"}),statusCode:e?.status}}},k=class{constructor(e){n(this,"secretKey"),n(this,"publishableKey"),n(this,"level"),n(this,"headers"),n(this,"url"),n(this,"customers",l(this)),n(this,"products",w(this)),n(this,"entities",v(this));try{this.secretKey=e?.secretKey||process.env.AUTUMN_SECRET_KEY,this.publishableKey=e?.publishableKey||process.env.AUTUMN_PUBLISHABLE_KEY}catch(e){}if(!this.secretKey&&!this.publishableKey)throw Error("Autumn secret key or publishable key is required");this.headers={Authorization:`Bearer ${this.secretKey||this.publishableKey}`,"Content-Type":"application/json"};let s=e?.version||"1.2";this.headers["x-api-version"]=s,this.url=e?.url||"https://api.useautumn.com/v1",this.level=this.secretKey?"secret":"publishable"}getLevel(){return this.level}async get(e){return P(await fetch(`${this.url}${e}`,{headers:this.headers}))}async post(e,s){return P(await fetch(`${this.url}${e}`,{method:"POST",headers:this.headers,body:JSON.stringify(s)}))}async delete(e){return P(await fetch(`${this.url}${e}`,{method:"DELETE",headers:this.headers}))}async attach(e){return f({instance:this,params:e})}async cancel(e){return A({instance:this,params:e})}async entitled(e){return T({instance:this,params:e})}async check(e){return I({instance:this,params:e})}async event(e){return y({instance:this,params:e})}async track(e){return x({instance:this,params:e})}async usage(e){return b({instance:this,params:e})}};n(k,"customers",l()),n(k,"products",w()),n(k,"entities",v()),n(k,"attach",e=>o(f,void 0,{params:e})),n(k,"usage",e=>o(b,void 0,{params:e})),n(k,"cancel",e=>o(A,void 0,{params:e})),n(k,"entitled",e=>o(T,void 0,{params:e})),n(k,"check",e=>o(I,void 0,{params:e})),n(k,"event",e=>o(y,void 0,{params:e})),n(k,"track",e=>o(x,void 0,{params:e}));var R=(e=>(e.Sandbox="sandbox",e.Live="live",e))(R||{}),U=(e=>(e.Active="active",e.Expired="expired",e.Trialing="trialing",e.Scheduled="scheduled",e))(U||{}),j="inf",C=(e=>(e.Day="day",e))(C||{}),M=(e=>(e.Prepaid="prepaid",e.PayPerUse="pay_per_use",e))(M||{}),q=(e=>(e.Minute="minute",e.Hour="hour",e.Day="day",e.Week="week",e.Month="month",e.Quarter="quarter",e.SemiAnnual="semi_annual",e.Year="year",e.Multiple="multiple",e))(q||{}),L=async({instance:e,params:s})=>{let t="/components/pricing_table";if(s){let e=new URLSearchParams;for(let[t,r]of Object.entries(s))"products"!==t&&void 0!==r&&e.append(t,String(r));let r=e.toString();r&&(t+=`?${r}`)}return await e.get(t)}},980970:e=>{"use strict";var{g:s,__dirname:t}=e;{e.s({SendEmailCommand:()=>s}),e.i(176357);var r=e.i(765519);e.i(74189);var i=e.i(517274);e.i(608477);var n=e.i(677114),a=e.i(477034),o=e.i(62265);class s extends n.Command.classBuilder().ep(a.commonParams).m(function(e,s,t,n){return[(0,i.getSerdePlugin)(t,this.serialize,this.deserialize),(0,r.getEndpointPlugin)(t,e.getEndpointParameterInstructions())]}).s("SimpleEmailService","SendEmail",{}).n("SESClient","SendEmailCommand").f(void 0,void 0).ser(o.se_SendEmailCommand).de(o.de_SendEmailCommand).build(){}}},125608:function(e){var{g:s,__dirname:t,m:r,e:i}=e},608681:e=>{"use strict";var{g:s,__dirname:t}=e;{e.s({POST:()=>h});var r=e.i(125427),i=e.i(494642),n=e.i(877465),a=e.i(980970),o=e.i(557440);e.i(468686);var l=e.i(55379),c=e.i(176825),d=e.i(459351),u=e.i(318812);function m(e){let s=e.match(/<(.+)>/);return s?s[1]:e.trim()}function p(e){return e?Array.isArray(e)?e:[e]:[]}let s=process.env.AWS_REGION||"us-east-2",t=process.env.AWS_ACCESS_KEY_ID,v=process.env.AWS_SECRET_ACCESS_KEY,S=null;async function h(e){console.log("📧 POST /api/v2/emails - Starting request");try{console.log("🔐 Validating request authentication");let{userId:s,error:t}=await (0,i.validateRequest)(e);if(!s)return console.log("❌ Authentication failed:",t),r.NextResponse.json({error:t},{status:401});console.log("✅ Authentication successful for userId:",s);let n=e.headers.get("Idempotency-Key");if(n){console.log("🔑 Idempotency key provided:",n);let e=await o.db.select().from(l.sentEmails).where((0,c.and)((0,c.eq)(l.sentEmails.userId,s),(0,c.eq)(l.sentEmails.idempotencyKey,n))).limit(1);if(e.length>0)return console.log("♻️ Idempotent request - returning existing email:",e[0].id),r.NextResponse.json({id:e[0].id})}console.log("📝 Parsing request body");let h=await e.json();if(!h.from||!h.to||!h.subject)return console.log("⚠️ Missing required fields"),r.NextResponse.json({error:"Missing required fields: from, to, and subject are required"},{status:400});if(!h.html&&!h.text)return console.log("⚠️ No email content provided"),r.NextResponse.json({error:"Either html or text content must be provided"},{status:400});let v=m(h.from),E=function(e){let s=m(e).split("@");return 2===s.length?s[1]:""}(h.from);console.log("📧 Sender details:",{from:h.from,address:v,domain:E}),console.log("🔍 Verifying domain ownership for:",E);let g=await o.db.select().from(l.emailDomains).where((0,c.and)((0,c.eq)(l.emailDomains.userId,s),(0,c.eq)(l.emailDomains.domain,E),(0,c.eq)(l.emailDomains.status,"verified"))).limit(1);if(0===g.length)return console.log("❌ User does not own the sender domain:",E),r.NextResponse.json({error:`You don't have permission to send from domain: ${E}`},{status:403});console.log("✅ Domain ownership verified");let _=p(h.to),f=p(h.cc),A=p(h.bcc),T=p(h.reply_to),y=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;for(let e of[..._,...f,...A]){let s=m(e);if(!y.test(s))return console.log("⚠️ Invalid email format:",e),r.NextResponse.json({error:`Invalid email format: ${e}`},{status:400})}console.log("🔍 Checking email sending limits with Autumn");let{data:x,error:b}=await d.Autumn.check({customer_id:s,feature_id:"emails_sent"});if(b)return console.error("❌ Autumn email check error:",b),r.NextResponse.json({error:"Failed to check email sending limits"},{status:500});if(console.log("🔍 Email check:",x),!x.allowed)return console.log("❌ Email sending limit reached for user:",s),r.NextResponse.json({error:"Email sending limit reached. Please upgrade your plan to send more emails."},{status:429});let I=(0,u.nanoid)();if(console.log("💾 Creating sent email record:",I),await o.db.insert(l.sentEmails).values({id:I,from:h.from,fromAddress:v,fromDomain:E,to:JSON.stringify(_),cc:f.length>0?JSON.stringify(f):null,bcc:A.length>0?JSON.stringify(A):null,replyTo:T.length>0?JSON.stringify(T):null,subject:h.subject,textBody:h.text,htmlBody:h.html,headers:h.headers?JSON.stringify(h.headers):null,attachments:h.attachments?JSON.stringify(h.attachments):null,status:l.SENT_EMAIL_STATUS.PENDING,userId:s,idempotencyKey:n,createdAt:new Date,updatedAt:new Date}).returning(),!S)return console.log("❌ AWS SES not configured"),await o.db.update(l.sentEmails).set({status:l.SENT_EMAIL_STATUS.FAILED,failureReason:"AWS SES not configured",updatedAt:new Date}).where((0,c.eq)(l.sentEmails.id,I)),r.NextResponse.json({error:"Email service not configured. Please contact support."},{status:500});try{console.log("📤 Sending email via AWS SES");let e=new a.SendEmailCommand({Source:h.from,Destination:{ToAddresses:_.map(m),CcAddresses:f.map(m),BccAddresses:A.map(m)},Message:{Subject:{Data:h.subject,Charset:"UTF-8"},Body:{...h.text&&{Text:{Data:h.text,Charset:"UTF-8"}},...h.html&&{Html:{Data:h.html,Charset:"UTF-8"}}}},...T.length>0&&{ReplyToAddresses:T.map(m)}}),t=await S.send(e),i=t.MessageId;if(console.log("✅ Email sent successfully via SES:",i),await o.db.update(l.sentEmails).set({status:l.SENT_EMAIL_STATUS.SENT,messageId:i,providerResponse:JSON.stringify(t),sentAt:new Date,updatedAt:new Date}).where((0,c.eq)(l.sentEmails.id,I)),!x.unlimited){console.log("📊 Tracking email usage with Autumn");let{error:e}=await d.Autumn.track({customer_id:s,feature_id:"emails_sent",value:1});e&&console.error("❌ Failed to track email usage:",e)}return console.log("✅ Email processing complete"),r.NextResponse.json({id:I},{status:200})}catch(e){return console.error("❌ SES send error:",e),await o.db.update(l.sentEmails).set({status:l.SENT_EMAIL_STATUS.FAILED,failureReason:e instanceof Error?e.message:"Unknown SES error",providerResponse:JSON.stringify(e),updatedAt:new Date}).where((0,c.eq)(l.sentEmails.id,I)),r.NextResponse.json({error:"Failed to send email. Please try again later."},{status:500})}}catch(e){return console.error("💥 Unexpected error in POST /api/v2/emails:",e),r.NextResponse.json({error:"Internal server error"},{status:500})}}t&&v?S=new n.SESClient({region:s,credentials:{accessKeyId:t,secretAccessKey:v}}):console.warn("⚠️ AWS credentials not configured. Email sending will not work.")}},938653:e=>{"use strict";var{g:s,__dirname:t}=e;{e.s({patchFetch:()=>o,routeModule:()=>s,serverHooks:()=>c,workAsyncStorage:()=>t,workUnitAsyncStorage:()=>l});var r=e.i(854885),i=e.i(814689),n=e.i(25402),a=e.i(608681);let s=new r.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/v2/emails/route",pathname:"/api/v2/emails",filename:"route",bundlePath:""},resolvedPagePath:"[project]/app/api/v2/emails/route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:t,workUnitAsyncStorage:l,serverHooks:c}=s;function o(){return(0,n.patchFetch)({workAsyncStorage:t,workUnitAsyncStorage:l})}}},993477:e=>{var{g:s,__dirname:t}=e;e.v(s=>Promise.all(["server/chunks/[root-of-the-server]__0a296e98._.js","server/chunks/node_modules_10ae7a2d._.js"].map(s=>e.l(s))).then(()=>s(611487)))},73518:e=>{var{g:s,__dirname:t}=e;e.v(s=>Promise.all(["server/chunks/[externals]_url_a7f1d978._.js","server/chunks/9f50b_@smithy_credential-provider-imds_dist-es_d5e4d7ca._.js"].map(s=>e.l(s))).then(()=>s(653223)))},855094:e=>{var{g:s,__dirname:t}=e;e.v(s=>Promise.all(["server/chunks/[externals]_fs_promises_1c68bc94._.js","server/chunks/9f50b_@aws-sdk_credential-provider-http_89f62eca._.js"].map(s=>e.l(s))).then(()=>s(515630)))},520835:e=>{var{g:s,__dirname:t}=e;e.v(s=>Promise.all(["server/chunks/9f50b_@aws-sdk_credential-provider-web-identity_93c38a87._.js"].map(s=>e.l(s))).then(()=>s(399432)))},404886:e=>{var{g:s,__dirname:t}=e;e.v(s=>Promise.all(["server/chunks/9f50b_@aws-sdk_credential-provider-process_dist-es_f8837f08._.js"].map(s=>e.l(s))).then(()=>s(31086)))},800893:e=>{var{g:s,__dirname:t}=e;e.v(s=>Promise.all(["server/chunks/9f50b_3c2eb32b._.js"].map(s=>e.l(s))).then(()=>s(387894)))},683391:e=>{var{g:s,__dirname:t}=e;e.v(s=>Promise.all(["server/chunks/9f50b_@aws-sdk_credential-provider-sso_22d6cb94._.js"].map(s=>e.l(s))).then(()=>s(695705)))},586469:e=>{var{g:s,__dirname:t}=e;e.v(s=>Promise.all(["server/chunks/[externals]_url_a7f1d978._.js","server/chunks/87a6c_@smithy_credential-provider-imds_dist-es_ee44b021._.js"].map(s=>e.l(s))).then(()=>s(488366)))}};

//# sourceMappingURL=%5Broot-of-the-server%5D__453f18d5._.js.map