{"version":3,"sources":["turbopack:///[project]/app/api/v1/webhooks/route.ts","turbopack:///[project]/node_modules/next/dist/src/build/templates/app-route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { auth } from '@/lib/auth/auth'\nimport { headers } from 'next/headers'\nimport { db } from '@/lib/db'\nimport { endpoints, webhooks } from '@/lib/db/schema'\nimport { eq, and } from 'drizzle-orm'\nimport { nanoid } from 'nanoid'\n\n/**\n * BACKWARD COMPATIBILITY LAYER\n * This API maintains compatibility with existing webhook integrations\n * while internally using the new endpoints system\n */\n\nexport async function GET(request: NextRequest) {\n  try {\n    console.log('üìã GET /api/v1/webhooks - Fetching webhooks (compatibility layer)')\n    \n    const session = await auth.api.getSession({ headers: await headers() })\n    if (!session?.user?.id) {\n      console.warn('‚ùå GET /api/v1/webhooks - Unauthorized request')\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    // Fetch webhook-type endpoints and legacy webhooks\n    const webhookEndpoints = await db\n      .select()\n      .from(endpoints)\n      .where(and(\n        eq(endpoints.userId, session.user.id),\n        eq(endpoints.type, 'webhook')\n      ))\n      .orderBy(endpoints.createdAt)\n\n    // Also fetch legacy webhooks for complete compatibility\n    const legacyWebhooks = await db\n      .select()\n      .from(webhooks)\n      .where(eq(webhooks.userId, session.user.id))\n      .orderBy(webhooks.createdAt)\n\n    // Convert endpoints to webhook format\n    const webhooksFromEndpoints = webhookEndpoints.map(endpoint => {\n      const config = JSON.parse(endpoint.config)\n      return {\n        id: endpoint.id,\n        name: endpoint.name,\n        url: config.url,\n        secret: config.secret || null,\n        isActive: endpoint.isActive,\n        description: endpoint.description,\n        headers: config.headers ? JSON.stringify(config.headers) : null,\n        timeout: config.timeout || 30,\n        retryAttempts: config.retryAttempts || 3,\n        lastUsed: null, // TODO: Get from delivery stats\n        totalDeliveries: 0, // TODO: Calculate from endpoint deliveries\n        successfulDeliveries: 0, // TODO: Calculate from endpoint deliveries\n        failedDeliveries: 0, // TODO: Calculate from endpoint deliveries\n        createdAt: endpoint.createdAt,\n        updatedAt: endpoint.updatedAt,\n        userId: endpoint.userId,\n        _source: 'endpoint' // Internal flag to indicate source\n      }\n    })\n\n    // Add legacy webhooks with source flag\n    const legacyWebhooksWithSource = legacyWebhooks.map(webhook => ({\n      ...webhook,\n      _source: 'legacy'\n    }))\n\n    // Combine both sources\n    const allWebhooks = [...webhooksFromEndpoints, ...legacyWebhooksWithSource]\n\n    console.log(`‚úÖ GET /api/v1/webhooks - Retrieved ${allWebhooks.length} webhooks (${webhookEndpoints.length} from endpoints, ${legacyWebhooks.length} legacy)`)\n\n    return NextResponse.json({ \n      webhooks: allWebhooks,\n      _deprecationNotice: 'This API is deprecated. Please migrate to /api/v1/endpoints for enhanced functionality.'\n    })\n\n  } catch (error) {\n    console.error('‚ùå GET /api/v1/webhooks - Error:', error)\n    return NextResponse.json(\n      { \n        error: 'Failed to fetch webhooks',\n        details: error instanceof Error ? error.message : 'Unknown error'\n      },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    console.log('üìù POST /api/v1/webhooks - Creating webhook (compatibility layer)')\n    \n    const session = await auth.api.getSession({ headers: await headers() })\n    if (!session?.user?.id) {\n      console.warn('‚ùå POST /api/v1/webhooks - Unauthorized request')\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    const data = await request.json()\n    \n    // Validate required webhook fields\n    if (!data.name || !data.url) {\n      return NextResponse.json(\n        { error: 'Missing required fields: name, url' },\n        { status: 400 }\n      )\n    }\n\n    // Validate URL format\n    try {\n      new URL(data.url)\n    } catch {\n      return NextResponse.json(\n        { error: 'Invalid URL format' },\n        { status: 400 }\n      )\n    }\n\n    console.log(`üìù POST /api/v1/webhooks - Creating webhook endpoint: ${data.name}`)\n\n    // Create as webhook endpoint (new system)\n    const webhookConfig = {\n      url: data.url,\n      secret: data.secret || undefined,\n      headers: data.headers ? JSON.parse(data.headers) : undefined,\n      timeout: data.timeout || 30,\n      retryAttempts: data.retryAttempts || 3\n    }\n\n    const newEndpoint = {\n      id: nanoid(),\n      name: data.name,\n      type: 'webhook' as const,\n      config: JSON.stringify(webhookConfig),\n      description: data.description || null,\n      userId: session.user.id,\n      isActive: data.isActive !== undefined ? data.isActive : true,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    }\n\n    const [createdEndpoint] = await db.insert(endpoints).values(newEndpoint).returning()\n\n    // Convert back to webhook format for response\n    const webhookResponse = {\n      id: createdEndpoint.id,\n      name: createdEndpoint.name,\n      url: webhookConfig.url,\n      secret: webhookConfig.secret || null,\n      isActive: createdEndpoint.isActive,\n      description: createdEndpoint.description,\n      headers: webhookConfig.headers ? JSON.stringify(webhookConfig.headers) : null,\n      timeout: webhookConfig.timeout,\n      retryAttempts: webhookConfig.retryAttempts,\n      lastUsed: null,\n      totalDeliveries: 0,\n      successfulDeliveries: 0,\n      failedDeliveries: 0,\n      createdAt: createdEndpoint.createdAt,\n      updatedAt: createdEndpoint.updatedAt,\n      userId: createdEndpoint.userId\n    }\n\n    console.log(`‚úÖ POST /api/v1/webhooks - Successfully created webhook endpoint ${createdEndpoint.id}`)\n\n    return NextResponse.json({ \n      webhook: webhookResponse,\n      _deprecationNotice: 'This API is deprecated. Please migrate to /api/v1/endpoints for enhanced functionality.'\n    }, { status: 201 })\n\n  } catch (error) {\n    console.error('‚ùå POST /api/v1/webhooks - Error:', error)\n    return NextResponse.json(\n      { \n        error: 'Failed to create webhook',\n        details: error instanceof Error ? error.message : 'Unknown error'\n      },\n      { status: 500 }\n    )\n  }\n} ","import {\n  AppRouteRouteModule,\n  type AppRouteRouteModuleOptions,\n} from '../../server/route-modules/app-route/module.compiled'\nimport { RouteKind } from '../../server/route-kind'\nimport { patchFetch as _patchFetch } from '../../server/lib/patch-fetch'\n\nimport * as userland from 'VAR_USERLAND'\n\n// These are injected by the loader afterwards. This is injected as a variable\n// instead of a replacement because this could also be `undefined` instead of\n// an empty string.\ndeclare const nextConfigOutput: AppRouteRouteModuleOptions['nextConfigOutput']\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\n// INJECT:nextConfigOutput\n\nconst routeModule = new AppRouteRouteModule({\n  definition: {\n    kind: RouteKind.APP_ROUTE,\n    page: 'VAR_DEFINITION_PAGE',\n    pathname: 'VAR_DEFINITION_PATHNAME',\n    filename: 'VAR_DEFINITION_FILENAME',\n    bundlePath: 'VAR_DEFINITION_BUNDLE_PATH',\n  },\n  resolvedPagePath: 'VAR_RESOLVED_PAGE_PATH',\n  nextConfigOutput,\n  userland,\n})\n\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule\n\nfunction patchFetch() {\n  return _patchFetch({\n    workAsyncStorage,\n    workUnitAsyncStorage,\n  })\n}\n\nexport {\n  routeModule,\n  workAsyncStorage,\n  workUnitAsyncStorage,\n  serverHooks,\n  patchFetch,\n}\n"],"names":["AppRouteRouteModule","RouteKind","patchFetch","_patchFetch","userland","routeModule","definition","kind","APP_ROUTE","page","pathname","filename","bundlePath","resolvedPagePath","nextConfigOutput","workAsyncStorage","workUnitAsyncStorage","serverHooks"],"mappings":"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","ignoreList":[1]}